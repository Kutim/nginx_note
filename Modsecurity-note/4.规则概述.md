Rule language directives

| Directive | Description|
|:---:|:---:|
|SecAction|Performs an unconditional action. This directive is essentially a rule that always matches.|
|SecDefaultAction| Specifies the default action list, which will be used in the rules that follow.|
|SecMarker|Creates a marker that can be used in conjunction with the skipAfter action. Amarker creates a rule that does nothing, but has an ID assigned to it.|
|SecRule|Creates a rule.|
|SecRuleInheritance| Controls whether rules are inherited in a child configuration context.|
|SecRuleRemoveById |Removes the rule with the given ID.|
|SecRuleRemoveByMsg| Removes the rule whose message matches the given regular expression.|
|SecRuleScript | Creates a rule implemented using Lua.|
|SecRuleUpdateActionById| Replaces the action list of the rule with the given ID with the supplied action list.|

- 规则解析
	**SecRule VARIABLES OPERATOR [TRANSFORMATION_FUNCTIONS, ACTIONS]**
	- Variables：规则对会话中感兴趣的项（binary strings）
	- Operators:Specify how is a (transformed) variable to be analyzed.(常用正则表达式)
	- Transformation functions：how each variable is to be changed before analysis can be done.
	- Actions：Specify what should be done when a rule matches.



##  1. Variables
	ModSecurity可以对 数据进行 预处理
	- 普通变量：包含一个信息或一个字符串。如 REMOTE_ADDRREMOTE_ADDR。
	- 集合变量：一组普通变量。如：ARGS、ENV
	- 只读集合变量：
	- 读写集合变量：如 TX
	- 特殊集合变量：如 XML的集合变量
	- 持久的集合变量：如tracking access per IP address or per session, or per user account.
	
###	1.1 Request variables
	
|Variable| Description|
|:---:|:---:|
|ARGS| Request parameters (read-only collection)
|ARGS_COMBINED_SIZE| Total size of all request parameters combined
|ARGS_NAMES| Request parameters’ names (collection)
|ARGS_GET| Query string parameters (read-only collection)
|ARGS_GET_NAMES| Query string parameters’ names (read-only collection)
|ARGS_POST| Request body parameters (read-only collection)
|ARGS_POST_NAMES| Request body parameters’ names (read-only collection)
|FILES| File names (read-only collection)
|FILES_COMBINED_SIZE| Combined size of all uploaded files
|FILES_NAMES| File parameter names (read-only collection)
|FILES_SIZES| A list of file sizes (read-only collection)
|FILES_TMPNAMES| A list of temporary file names (read-only collection)
|PATH_INFO| Extra path information
|QUERY_STRING| Request query string
|REMOTE_USER| Remote user
|REQUEST_BASENAME| Request URI basename
|REQUEST_BODY| Request body
|REQUEST_COOKIES| Request cookies (read-only collection)
|REQUEST_COOKIES_NAMES| Request cookies’ names (read-only collection)
|REQUEST_FILENAME| Request URI filename/path
|REQUEST_HEADERS| Request headers (collection, read-only)
|REQUEST_HEADERS_NAMES| Request headers’ names (read-only collection)
|REQUEST_LINE |Request line
|REQUEST_METHOD| Request method
|REQUEST_PROTOCOL| Request protocol
|REQUEST_URI| Request URI, convert to exclude hostname
|REQUEST_URI_RAW |Request URI, as it was presented in the request

###1.2 Server variables

|Variable| Description|
|:---:|:---:|
|AUTH_TYPE| Authentication type
|REMOTE_ADDR| Remote address
|REMOTE_HOST| Remote host
|REMOTE_PORT| Remote port
|SCRIPT_BASENAME| Script basename
|SCRIPT_FILENAME| Script filename/path
|SCRIPT_GID| Script group ID
|SCRIPT_GROUPNAME| Script group name
|SCRIPT_MODE| Script permissions
|SCRIPT_UID| Script user ID
|SCRIPT_USERNAME| Script user name
|SERVER_ADDR| Server address
|SERVER_NAME| Server name
|SERVER_PORT| Server port

###1.3 Response variables

|Variable| Description|
|:---:|:---:|
|RESPONSE_BODY| Response body
|RESPONSE_CONTENT_LENGTH| Response content length
|RESPONSE_CONTENT_TYPE| Response content type
|RESPONSE_HEADERS| Response headers (read-only collection)
|RESPONSE_HEADERS_NAMES| Response headers’ names (read-only collection)
|RESPONSE_PROTOCOL| Response protocol
|RESPONSE_STATUS| Response status code

###1.4 Miscellaneous variables

|Variable| Description|
|:---:|:---:|
|HIGHEST_SEVERITY |Highest severity encountered
|MATCHED_VAR| Contents of the last variable that matched
|MATCHED_VAR_NAME| Name of the last variable that match
|MODSEC_BUILD| ModSecurity build version (e.g., 02050102)
|SESSIONID |Session ID associated with current transaction
|USERID |User ID associated with current transaction
|WEBAPPID| Web application ID associated with current transaction
|WEBSERVER_ERROR_LOG| Error messages generated by Apache during current transaction

###1.5 Parsing flags
	signal important parsing events.

|Variable| Description|
|:---:|:---:|
|MULTIPART_BOUNDARY_QUOTED |Multipart parsing error: quoted boundary encountered
|MULTIPART_BOUNDARY_WHITESPACE |Multipart parsing error: whitespace in boundary
|MULTIPART_CRLF_LF_LINES |Multipart parsing error: mixed line endings used
|MULTIPART_DATA_BEFORE| Multipart parsing error: seen data before first boundary
|MULTIPART_DATA_AFTER |Multipart parsing error: seen data after last boundary
|MULTIPART_HEADER_FOLDING |Multipart parsing error: header folding used
|MULTIPART_LF_LINE Multipart| parsing error: LF line ending detected
|MULTIPART_SEMICOLON_MISSING Multipart| parsing error: missing semicolon before boundary
|MULTIPART_STRICT_ERROR| At least one multipart error except MULTIPART_UNMATCHED_BOUNDARY occurred
|MULTIPART_UNMATCHED_BOUNDARY| Multipart parsing error: unmatched boundary detected (prone to false positives)
|REQBODY_PROCESSOR| Request processor that handled request body
|REQBODY_PROCESSOR_ERROR| Request processor error flag (0 or 1)
|REQBODY_PROCESSOR_ERROR_MSG| Request processor error message

###1.6 Collections

|Variable| Description|
|:---:|:---:|
|ENV| Environment variables (read-only collection, although it’s possible to use setvar to change it)
|GEO| Geo lookup information from the last @geoLookup invocation (read-only collection)
|GLOBAL| Global information, shared by all processes (read/write collection)
|IP| IP address data storage (read/write collection)
|TX| Transient transaction data (read/write collection)
|RULE| Current rule metadata (read-only collection)
|SESSION| Session data storage (read/write collection)
|USER| User data storage (read/write collection)
|XML| XML DOM tree (read-only collection)

###1.7 Time variables

|Variable| Description|
|:---:|:---:|
|TIME| Time (HH:MM:SS)
|TIME_DAY| Day of the month (1-31)
|TIME_EPOCH| Seconds since January 1, 1970 (e.g., 1251029017)
|TIME_HOUR| Hour of the day (0-23)
|TIME_MIN| Minute of the hour (0-59)
|TIME_MON |Month of the year (0-11)
|TIME_SEC| Second of the minute (0-59)
|TIME_WDAY| Week day (0-6)
|TIME_YEAR| Year


## 2. Operators
	
	SecRule ARGS:username "@rx ^(admin|root)$"
### 2.1 String matching operators

|Operator| Description|
|:---:|:---:|
|@beginsWith| Begins with
|@contains| Contains
|@endsWith| Ends with
|@rx| Regular pattern match
|@pm| Parallel matching
|@pmFromFile (@pmf in v2.6)| Parallel matching, with arguments from a file
|@streq| String equal to
|@within| Within

### 2.2 Numerical operators

|Operator| Description|
|:---:|:---:|
|@eq| Equal
|@ge| Greater or equal
|@gt| Greater than
|@le| Less or equal
|@lt| Less than

### 2.3 Validation operators

|Operator| Description|
|:---:|:---:|
|@validateByteRange| Validates that parameter consists only of allowed byte values
|@validateDTD| Validates XML payload against a DTD
|@validateSchema| Validates XML payload against a Schema
|@validateUrlEncoding| Validates an URL-encoded string
|@validateUtf8Encoding| Validates an UTF-8 encoded string

### 2.4 Miscellaneous operators

|Operator| Description|
|:---:|:---:|
|@geoLookup| Determines the physical location of an IP address
|@inspectFile| Invokes an external script to inspect a file
|@rbl| Looks parameter against a RBL (real-time block list)
|@verifyCC| Checks if the parameter is a valid credit card number

##3. Actions
###3.1 Disruptive actions
	
	Each rule must be associated with exactly one disruptive action(pass 例外)

|Action| Description|
|:---:|:---:|
|allow| Stop processing of one or more remaining phases
|block| Indicates that a rule wants to block
|deny| Block transaction with an error page
|drop| Close network connection
|pass| Do not block, go to the next rule
|proxy| Proxy request to a backend web server
|redirect| Redirect request to some other web server

###3.2 Flow actions

|Action| Description|
|:---:|:---:|
|chain| Connect two or more rules into a single logical rule
|skip| Skip over one or more rules that follow
|skipAfter| Skip to the rule or marker with the provided ID

###3.3 Metadata actions

|Action| Description|
|:---:|:---:|
|id |Assign unique ID to a rule
|phase| Phase for a rule to run in
|msg| Message string
|rev| Revision number
|severity| Severity
|tag| Tag

###3.4 Variable actions

|Action| Description|
|:---:|:---:|
|capture| Capture results into one or more variables
|deprecatevar| Decrease numerical variable value over time
|expirevar|Remove variable after a time period
|initcol| Create a new persistent collection
|setenv| Set or remove an environment variable
|setvar| Set, remove, increment or decrement a variable
|setuid| Associate current transaction with an application user ID (username)
|setsid| Associate current transaction with an application session ID

###3.5 Logging actions

|Action| Description|
|:---:|:---:|
|auditlog| Log current transaction to audit log
|log| Log error message; implies auditlog
|logdata| Log supplied data as part of error message
|noauditlog| Do not log current transaction to audit log
|nolog| Do not log error message; implies noauditlog
|sanitiseArg| Remove request parameter from audit log
|sanitiseMatched| Remove parameter in which a match occurred from audit log
|sanitiseRequestHeader| Remove request header from audit log
|sanitiseResponseHeader| Remove response header from audit log

###3.6 Special actions

|Action| Description|
|:---:|:---:|
|ctl| Change configuration of current transaction
|multiMatch| Activate multi-matching, where an operator runs after every transformation
|t| Specify transformation functions to apply to variables before matching

###3.7 Miscellaneous actions

|Action| Description|
|:---:|:---:|
|append| Append content to response body
|exec| Execute external script
|pause| Pause transaction
|prepend| Prepend content to response body
|status| Specify response status code to use with deny and redirect
|xmlns| Specify name space for use with XPath expressions